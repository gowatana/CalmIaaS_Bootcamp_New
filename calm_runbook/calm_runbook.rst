.. _calm_runbook:

-----------------------------------------
Calm: Runbook
-----------------------------------------

概要
++++++++

:ref:`calm_iaas_linux` と :ref:`calm_iaas_windows` の演習では、BashやPowerShellスクリプトを利用してアプリケーションのデプロイを自動化する方法を検討しました。シェルスクリプトは強力で汎用性がありますが、スクリプトをローカルにコピーして実行するためのエンドポイントVMをデプロイする必要があります。また、前の演習で行ったeScriptはブループリントによる仮想マシンの作成なしにRESTfulサービスへのAPI呼び出しなどをCalmから行うものでしたが、やはりPrism Centralを"既存の仮想マシン"としてブループリントに取り込む必要がありました。ブループリントによる仮想マシンの作成や既存仮想マシンの取り込みなしにIT運用タスクを自動実行する汎用的な仕組みはないでしょうか？あります、Calm 3.0でリリースされたRunbook(指示書)は汎用的なIT運用タスクを自動化し、ブループリントと同じくプロジェクトユーザに対して公開してセルフサービスで実行を行わせることが可能です。

このラボでは、Calm Runbookを使用して、WindowsサーバのIaaSサービスの章で作成したWindows Server OSのアップデートを行うRunbookを作成し、マーケットプレイスに公開します。

エンドポイントの作成
+++++++++

エンドポイントはシェルスクリプト、Powershell、REST APIを実行する仮想マシンです。Runbookは設定されたエンドポイントに接続し、定義されたアクションを実行します。

#. **Prism Central** で、 :fa:`bars` **> サービス > Calm** を選択します。

#. 左側のツールバーの **Endpoints** を選択して、Endpointを表示および管理します。

#. **+エンドポイントを作成** を選択します。

#. 以下の項目を記入し、 **保存** をクリックします。

   - **名前** - *あなたのイニシャル*-Windows
   - **説明** - 任意
   - **プロジェクト** - *あなたのイニシャル*-Project
   - **タイプ** - Windows
   - **ターゲットの種類** - 仮想マシン
   - **アカウント** - NTNX_LOCAL_AZ
   - **フィルタ条件** - **名前** , **開始** , **あなたのイニシャル-Win2016** を入力し、 **追加** をクリック、あなたのWindows仮想マシンのうち、タイムスタンプが古い方を選択
   - **認証情報**
      - **ユーザ名** - Administrator
      - **秘密のタイプ** - パスワード
      - **パスワード** - Nutanix/4u

   .. figure:: images/endpoint-1.png
   .. figure:: images/endpoint-2.png

Runbookの作成
+++++++++

Runbookは自動化したいIT運用タスクを定義するものです。インタフェースはシンプルながらも分岐やループを用いて複雑な運用ロジックを定型化することが可能です。

#. 左側のツールバーの **Runbooks** を選択して、CalmのRunbookを表示および管理します。

#. `こちら <https://raw.githubusercontent.com/shocnt/CalmIaaS_Bootcamp_New/master/calm_runbook/Runbook-Windows-Patching.json>`_ からテンプレートとなるRunbookをローカルマシンにダウンロードします。(ブラウザの機能においてファイルを別名ダウンロードしてください。)

#. **指示書をアップロード** をクリックし、ダウンロードしたjsonファイル(Runbook-Windows-Patching.json)を選択します。

#. 以下の項目を記入し、　**アップロード**　をクリックします。

   - **指示書名** - *あなたのイニシャル*-Windows-Patching
   - **プロジェクト** - *あなたのイニシャル*-Project

   .. figure:: images/runbook-1.png

#. 上部の"設定"タブから、 **デフォルトエンドポイント(任意)** 部分に先程作成した*あなたのイニシャル*-Windowsのエンドポイントを選択します。

#. **保存** をクリックします。

アップロードしたRunbookの仕組みは以下となっています。 **本Runbookはサンプル提供となっており、本番環境での使用にあたる責任は負いかねます。**

- Windowsアップデートサービスの有無確認、ない場合は有効化
- chocolateyの有無確認、ない場合はインストール
- PSWindowsUpdateモジュールの有無確認、ない場合はインストール
- Windows Updateの有無確認、あった場合インストール
- 再起動の要否確認、必要な場合は再起動

Runbookの実行
+++++++++++++++++++++++++++++++

#. **実行** をクリックし、ポップアップされる画面にて再度、 **実行**　をクリックします。

   .. figure:: images/runbook-2.png

#. **監査** タブに移行し、Runbookに定義されたアクションが実行されている様子がご確認頂けます。

   .. figure:: images/runbook-3.png

Runbookの公開
+++++++++++++++++++++++++++++++

ブループリントと同様に作成したRunbookをマーケットプレイスに公開し、ユーザがセルフサービスで使用することが出来ます。

#. 左側のツールバーの **Runbooks** を選択して、CalmのRunbookを表示および管理します。

#. **公開** をクリックします。

#. 以下の項目を記入し、　**承認用に送信**　をクリックします。

   - **名前** - あなたのイニシャル-Windows-Patching
   - **シークレットとともにパブリッシュ** - オフ
   - **エンドポイントを含めて公開** - オフ
   - **初期バージョン** - 1.0.0
   - **説明** - 任意

   .. figure:: images/runbook-4.png

   .. note::
     シークレットとともにパブリッシュ: デフォルトでは、Runbook内に設定された認証情報は公開されたRunbookにおいて保存されません。その結果、マーケットプレイスアイテムの起動時に、認証情報はユーザーが入力しなければなりません。
     エンドポイントを含めて公開: デフォルトでは、Runbook内に設定されたエンドポイント情報は公開されたRunbookにおいて保存されません。その結果、マーケットプレイスアイテムの起動時に、エンドポイント情報はユーザーが入力しなければなりません。

Runbookの承認
....................

#. 左側のツールバーで、 **Marketplace Manager** をクリックし、マーケットプレイスのアイテムを表示します。

#. マーケットプレイスのブループリントとそのバージョンのリストが表示されます。ページ上部の **承認を保留** を選択します。

#. **あなたのイニシャル-Windows-Patching** ブループリントを表示します。

#. 利用可能なアクションを確認します。

   - **承認** - マーケットプレイスに公開するためのブループリントを承認します。
   - **拒否** - ブループリントがマーケットプレイスで公開されないようにします。ブループリントを公開するには、拒否された後に再度提出する必要があります。
   - **削除** - マーケットプレイスへのブループリントの提出を削除します。
   - **起動** - ブループリントエディタから起動するのと同様に、アプリケーションとしてブループリントを起動します。

#. 利用可能な選択肢を確認します。

   - **カテゴリ** - 新しいマーケットプレイスのブループリントのカテゴリを更新することができます。
   - **共有するプロジェクト** - マーケットプレイスのブループリントを特定のプロジェクトでのみ利用できるようにします。

#. **承認** をクリックします。

#. ページの上部にある **承認済み** を選択し、検索バーにあなたの *イニシャル* を入力してください。あなたのブループリントが **認められた** のステータスで表示されているはずです。

#. まだこの状態ではRunbookが公開可能になったのみで、マーケットプレイスへの公開を行う必要があります。下のように設定し、 **適用** をクリックします。

   - **共有するプロジェクト** - *あなたのイニシャル*-プロジェクト

#. **公開** をクリックし、マーケットプレイスにRunbookを公開します。
       
#. あなたのRunbookが **公開された** のステータスで表示されているはずです。

#. 左側のツールバーで、 **Marketplace** をクリックし、マーケットプレイスに公開されたアイテムを表示します。

終わりに
+++++++++

**Nutanix Calm** について知っておくべき重要なことは何ですか？

- Runbookは仮想マシンの起動や既存仮想マシンの取り込みなしに汎用的なIT運用タスクを自動化するエンジンです

- エンドポイントはRunbookで定義されたアクションを行う仮想マシンの設定を行います

- Runbookはブループリントと同様、マーケットプレイスに公開してユーザにセルフサービス公開が可能です。

.. |proj-icon| image:: ../images/projects_icon.png
.. |mktmgr-icon| image:: ../images/marketplacemanager_icon.png
.. |mkt-icon| image:: ../images/marketplace_icon.png
.. |bp-icon| image:: ../images/blueprints_icon.png
.. |blueprints| image:: images/blueprints.png
.. |applications| image:: images/blueprints.png
